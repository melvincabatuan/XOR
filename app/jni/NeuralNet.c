#include "io_github_melvincabatuan_xor_MainActivity.h"
#include <android/log.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>

#define  LOG_TAG    "XOR"
#define  LOGI(...)  __android_log_print(ANDROID_LOG_INFO,LOG_TAG,__VA_ARGS__)
#define  LOGE(...)  __android_log_print(ANDROID_LOG_ERROR,LOG_TAG,__VA_ARGS__)
#define  DEBUG 0

const int no_of_input_fields = 2;
const int no_of_inputs = 64;
const int no_of_hiddens = 5;
const int no_of_outputs = 1;
const int hidden_layers = 1;
 
int field_length[] = {
  32,32
};
 
float input_range_min[] = {
  0.2500000000,0.2500000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000,99999.0000000000
};
 
float input_range_max[] = {
  0.7500000000,0.7500000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000,-99999.0000000000
};
 
float output_range_min[] = {
  0.0000000000
};
 
float output_range_max[] = {
  1.0000000000
};
 
float hidden_layer_0_weights[] = {
  0.3346764743,0.3398242295,0.3562150598,0.3413356245,-0.3764873445,0.3368233740,0.3458498418,-0.3564257622,-0.3614448011,0.3459926546,0.3390386999,0.3406790495,-0.3621873856,0.3414553106,0.3407242000,-0.3682117760,0.3337758780,-0.3760168254,0.3291380703,-0.3660399318,-0.3676575720,0.3376539648,0.3381783068,-0.3609765172,-0.0145434029,-0.0238435995,-0.0070236959,-0.0103212930,0.0054679597,-0.0079944730,-0.0153392972,0.0074121188,0.2970145345,0.3396653235,0.2719656527,0.3449884355,-0.3137946427,0.3404524028,0.3422521651,-0.3607187569,-0.3326956928,0.3005810082,0.3418401182,0.2969079614,-0.3591631055,0.3445643485,0.3439777792,-0.3624405265,0.3007147908,-0.3311666548,0.2873590589,-0.3702057898,-0.3096776903,0.3392217457,0.3382937014,-0.3639681935,0.0043258211,0.0054415730,0.0071236459,0.0104808975,-0.0113837123,0.0092261843,0.0091954432,-0.0103217643,0.6529182196,0.2765708268,0.6424126625,0.2774947584,-0.7611517310,0.2782402933,0.2750632465,-0.3925866783,-0.7583158612,0.6382728815,0.2744931877,0.6298112869,-0.3876460493,0.2743673027,0.2717741430,-0.3891991079,0.6565257311,-0.7682173848,0.6391880512,-0.3907872140,-0.7704053521,0.2817487419,0.2770707905,-0.3940813243,-0.2543890476,-0.2444847524,-0.2528896928,-0.2473769784,0.1297957599,-0.2474443018,-0.2472578883,0.1306030005,0.6595640182,0.2795583308,0.6766575575,0.2702119052,-0.7924543619,0.2763073146,0.2773804367,-0.3907661140,-0.7718968391,0.6645081043,0.2753277123,0.6521158218,-0.3919117749,0.2770245969,0.2729741037,-0.3886180222,0.6661832333,-0.7768415809,0.6642092466,-0.3877073228,-0.7832022309,0.2767293155,0.2742749155,-0.3938449919,-0.2451000810,-0.2459226251,-0.2461386025,-0.2493633926,0.1268984973,-0.2531779706,-0.2475687861,0.1206518039,-2.1961491108,0.0136337569,-2.1960477829,0.0136428140,2.1894569397,0.0136199761,0.0136633823,-0.0155655462,2.1895394325,-2.1961095333,0.0136267766,-2.1961510181,-0.0155894663,0.0136393774,0.0136321597,-0.0156232901,-2.1961488724,2.1894488335,-2.1961998940,-0.0156139955,2.1894912720,0.0136289904,0.0136256767,-0.0155915087,1.1013085842,1.1012684107,1.1013648510,1.1013553143,-1.1049630642,1.1013714075,1.1013205051,-1.1049562693,0.0135562764,0.0136367418,0.0134443678,0.0136526264,-0.0155167319,0.0136366747,0.0136475200,-0.0155858481,-0.0155930053,0.0135836396,0.0136427041,0.0135440771,-0.0155790774,0.0136591271,0.0136508550,-0.0155921280,0.0135870129,-0.0155917611,0.0135103595,-0.0156356879,-0.0154792620,0.0136307282,0.0136225764,-0.0156070217,-0.0009457328,-0.0009411678,-0.0009330189,-0.0009203064,-0.0009216990,-0.0009312058,-0.0009245225,-0.0009239541,0.4241241515,0.3949730396,0.4130857289,0.3925372958,-0.3822296560,0.3963046074,0.3904544413,-0.3707704544,-0.4001154900,0.4274537861,0.3978374004,0.4412367046,-0.3699489534,0.3955462873,0.3988716900,-0.3623698652,0.4214173853,-0.3756317198,0.4434009790,-0.3629539311,-0.3818067014,0.3919618726,0.3961190879,-0.3647240400,0.0144636733,0.0138193769,0.0054320511,0.0031866462,0.0105894562,0.0009252406,0.0080866804,0.0078351991,0.4066319466,0.3921422362,0.4145951867,0.3961689174,-0.3651131392,0.3946086466,0.3917346299,-0.3682973683,-0.3667701781,0.3981170356,0.3942002356,0.4141884744,-0.3687077463,0.3897782862,0.3944173157,-0.3687235415,0.3963078260,-0.3633528650,0.4116441607,-0.3618674874,-0.3784869313,0.3954175711,0.3988009989,-0.3619680703,0.0105690314,0.0102761472,0.0088109886,0.0086792232,0.0060183532,0.0138066085,0.0081697367,0.0111928694,0.0080582602,0.0113535402,0.0081093786,0.0113615533,-0.0108658914,0.0113471849,0.0113710808,-0.0140857575,-0.0107983500,0.0080571203,0.0113446461,0.0080103679,-0.0140928458,0.0113530988,0.0113431243,-0.0141193699,0.0080659641,-0.0108854789,0.0079945503,-0.0141160348,-0.0108598992,0.0113601973,0.0113488780,-0.0141066844,0.0002639796,0.0002604711,0.0002935144,0.0002980164,-0.0029639085,0.0003054990,0.0002815505,-0.0029555908,-2.1958470345,0.0113613317,-2.1958923340,0.0113543058,2.1908233166,0.0113550099,0.0113646341,-0.0140963662,2.1908128262,-2.1958181858,0.0113573177,-2.1958696842,-0.0140938293,0.0113719376,0.0113584278,-0.0140966009,-2.1958127022,2.1908040047,-2.1958689690,-0.0141223865,2.1908652782,0.0113516999,0.0113413231,-0.0141170509,1.1024405956,1.1024411917,1.1024450064,1.1024469137,-1.1040107012,1.1024338007,1.1024473906,-1.1040292978
};
 
float hidden_layer_0_bias[] = {
  0.7402771711,0.6479402184,-0.3042273819,0.9521739483,-0.2795352042
};
 
float output_layer_weights[] = {
  -1.6559672356,6.7608628273,2.6438059807,-2.5956721306,2.6896839142
};
 
float output_layer_bias[] = {
  -3.6149082184
};
 
float inputs[64];
float network_inputs[64];
float prev_hiddens[5];
float hiddens[5];
float outputs[1];
 
/* Encode some text into the input units */
void encode_text(char * text,
                 float * inputs, int no_of_inputs,
                 int offset, int max_field_length_chars)
{
  int pos = offset, i, bit, max_chars = strlen(text);
 
  if (max_chars > (no_of_inputs-offset)/8) {
    max_chars = ((no_of_inputs-offset)/8);
  }
  if (max_chars > max_field_length_chars) {
    max_chars = max_field_length_chars;
  }
 
  /* for each character in the string */
  for (i = 0; i < max_chars; i++) {
    /* set the bits for this character */
    for (bit = 0; bit < 8; bit++, pos++) {
      if (text[i] & (1<<bit)) {
        inputs[pos] = 0.75f;
      }
      else {
        inputs[pos] = 0.25f;
      }
    }
  }
  /* set the remaining inputs within the field to neutral */
  while (i < max_field_length_chars) {
    for (bit = 0; bit < 8; bit++) {
      if (pos >= no_of_inputs) {
        i = max_field_length_chars;
        break;
      }
      inputs[pos++] = 0.5f;
    }
    i++;
  }
}


 

/*
 * Class:     io_github_melvincabatuan_xor_MainActivity
 * Method:    xor
 * Signature: (ZZZ)V
 */
JNIEXPORT jint JNICALL Java_io_github_melvincabatuan_xor_MainActivity_xor
  (JNIEnv * pEnv, jobject clazz, jboolean sw1, jboolean sw2){


    int i,j,pos;
    float sum;
    char sw1_text[5];
    char sw2_text[5];

   if (sw1){
      strcpy(sw1_text,"one");        
   }
   else {
      strcpy(sw1_text,"zero");      
   }

   inputs[0] = atof(sw1_text);

    if (sw2){
      strcpy(sw2_text,"one");
   }
   else {
      strcpy(sw2_text,"zero");
      
   }
 
   inputs[1] = atof(sw2_text);
   

   pos = 0;

   i = 0;
 
    if (field_length[i] == 0) {
      /* Normalise numeric inputs into a 0.25 - 0.75 range */
      network_inputs[pos] = 0.25f + ((inputs[i] - input_range_min[i])*0.5f/(input_range_max[i] - input_range_min[i]));
      if (network_inputs[pos] < 0.25f) network_inputs[pos] = 0.25f;
      if (network_inputs[pos] > 0.75f) network_inputs[pos] = 0.75f;
      pos++;
    }
    else {
      /* text value */
      encode_text(sw1_text, network_inputs, no_of_inputs,
                  pos, field_length[i]/8);
      pos += field_length[i];
    }

     i = 1;
 
    if (field_length[i] == 0) {
      /* Normalise numeric inputs into a 0.25 - 0.75 range */
      network_inputs[pos] = 0.25f + ((inputs[i] - input_range_min[i])*0.5f/(input_range_max[i] - input_range_min[i]));
      if (network_inputs[pos] < 0.25f) network_inputs[pos] = 0.25f;
      if (network_inputs[pos] > 0.75f) network_inputs[pos] = 0.75f;
      pos++;
    }
    else {
      /* text value */
      encode_text(sw2_text, network_inputs, no_of_inputs,
                  pos, field_length[i]/8);
      pos += field_length[i];
    }
 
 
  /* Hidden layer 0 */
  for (i = 0; i < no_of_hiddens; i++) {
    sum = hidden_layer_0_bias[i];
    for (j = 0; j < no_of_inputs; j++) {
      sum += hidden_layer_0_weights[i*no_of_inputs+j]*network_inputs[j];
    }
    hiddens[i] = 1.0f / (1.0f + exp(-sum));
  }
  for (i = 0; i < no_of_hiddens; i++) {
    prev_hiddens[i] = hiddens[i];
  }
 
  /* Output layer */
  for (i = 0; i < no_of_outputs; i++) {
    sum = output_layer_bias[i];
    for (j = 0; j < 5; j++) {
      sum += output_layer_weights[i*5+j]*prev_hiddens[j];
    }
    outputs[i] = 1.0f / (1.0f + exp(-sum));
  }
 
  for (i = 0; i < no_of_outputs; i++) {

    /* Convert outputs from 0.25 - 0.75 back to their original range */
    outputs[i] = output_range_min[i] + ((outputs[i]-0.25f)*(output_range_max[i] - output_range_min[i])/0.5f);
    /* Send the outputs to stdout */
    LOGI("%.10f",outputs[i]);

  if (outputs[i] > 0.5)
      return 1;
  else
      return 0;
  }


}
